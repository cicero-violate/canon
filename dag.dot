digraph Canon_DAG {

  label = "Canon Level-7 Execution DAG";
  labelloc = top;
  fontsize = 18;
  rankdir = LR;
  fontname = "JetBrains Mono";

  node [
    shape=box,
    style=rounded,
    fontname="JetBrains Mono",
    fontsize=10
  ];

  edge [
    fontname="JetBrains Mono",
    fontsize=9
  ];

  /* ===== Declarative Construction ===== */

  DSL [
    label="DSL\n(text input)",
    shape=component
  ];

  Proposal [
    label="Proposal\n(nodes, apis, edges)"
  ];

  ResolvedNodes [
    label="ResolvedProposalNodes\n(ids + bindings)"
  ];

  CanonicalIR [
    label="CanonicalIr\n(validated DAG)"
  ];

  DSL -> Proposal [label="parse"];
  Proposal -> ResolvedNodes [label="resolve ids"];
  ResolvedNodes -> CanonicalIR [label="validate"];

  /* ===== Judgment & Proof ===== */

  Judgment [
    label="Judgment\n(radius + policy)"
  ];

  ProofArtifact [
    label="ProofArtifact\n(scope + hash)"
  ];

  CanonicalIR -> Judgment [label="declare"];
  Judgment -> ProofArtifact [label="prove"];

  /* ===== Admission (Gate Only) ===== */

  Admission [
    label="Admission\n(accept / reject)"
  ];

  ProofArtifact -> Admission [label="certificate"];
  Judgment -> Admission;

  /* ===== Kernel (SOLE MUTATION AUTHORITY) ===== */

  Kernel [
    label="Kernel\n(apply + invariants + hash)",
    shape=octagon,
    style="rounded,filled",
    fillcolor=lightgray
  ];

  Admission -> Kernel [label="if accepted"];

  /* ===== Delta Generation ===== */

  Delta [
    label="Delta\n(state transition)"
  ];

  Kernel -> Delta [label="emit"];

  /* ===== Append-Only Ledger ===== */

  StateLog [
    label="StateLog\n(append-only ledger)",
    shape=folder
  ];

  Kernel -> StateLog [label="append delta"];

  /* ===== Canonical State ===== */

  CanonicalState [
    label="CanonicalState\n(materialized state)"
  ];

  RootHash [
    label="RootHash\n(H(state))"
  ];

  StateLog -> CanonicalState [label="replay"];
  CanonicalState -> RootHash [label="compute"];

}
